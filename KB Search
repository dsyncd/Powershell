<# This form was created using POSHGUI.com  a free online gui designer for PowerShell
.NAME
    KB Search by Chas Daugherty 
#>

Add-Type -AssemblyName System.Windows.Forms
[System.Windows.Forms.Application]::EnableVisualStyles()

$KBSearch                        = New-Object system.Windows.Forms.Form
$KBSearch.ClientSize             = '400,400'
$KBSearch.text                   = "KB Search"
$KBSearch.TopMost                = $false

$txtKB                           = New-Object system.Windows.Forms.TextBox
$txtKB.multiline                 = $false
$txtKB.width                     = 108
$txtKB.height                    = 20
$txtKB.location                  = New-Object System.Drawing.Point(199,51)
$txtKB.Font                      = 'Microsoft Sans Serif,10'

$btnGetKB                        = New-Object system.Windows.Forms.Button
$btnGetKB.text                   = "Search"
$btnGetKB.width                  = 70
$btnGetKB.height                 = 30
$btnGetKB.location               = New-Object System.Drawing.Point(321,43)
$btnGetKB.Font                   = 'Microsoft Sans Serif,10'

$Label1                          = New-Object system.Windows.Forms.Label
$Label1.text                     = "Search computers to see if KB is installed."
$Label1.AutoSize                 = $true
$Label1.width                    = 25
$Label1.height                   = 10
$Label1.location                 = New-Object System.Drawing.Point(18,13)
$Label1.Font                     = 'Microsoft Sans Serif,10'

$dgInstalled                     = New-Object system.Windows.Forms.DataGridView
$dgInstalled.width               = 177
$dgInstalled.height              = 250
$dgInstalled.location            = New-Object System.Drawing.Point(15,110)
$dgInstalled.ColumnCount         = 1

$dgNotInstalled                  = New-Object system.Windows.Forms.DataGridView
$dgNotInstalled.width            = 182
$dgNotInstalled.height           = 250
$dgNotInstalled.location         = New-Object System.Drawing.Point(199,110)
$dgNotInstalled.ColumnCount      = 1

$Label2                          = New-Object system.Windows.Forms.Label
$Label2.text                     = "KB Installed"
$Label2.AutoSize                 = $true
$Label2.width                    = 25
$Label2.height                   = 10
$Label2.location                 = New-Object System.Drawing.Point(21,84)
$Label2.Font                     = 'Microsoft Sans Serif,10'

$Label3                          = New-Object system.Windows.Forms.Label
$Label3.text                     = "KB not Installed"
$Label3.AutoSize                 = $true
$Label3.width                    = 25
$Label3.height                   = 10
$Label3.location                 = New-Object System.Drawing.Point(205,84)
$Label3.Font                     = 'Microsoft Sans Serif,10'

$cbOU                            = New-Object system.Windows.Forms.ComboBox
$cbOU.text                       = "Select OU"
$cbOU.width                      = 150
$cbOU.height                     = 20
$cbOU.location                   = New-Object System.Drawing.Point(18,52)
$cbOU.Font                       = 'Microsoft Sans Serif,10'

$KBSearch.controls.AddRange(@($txtKB,$btnGetKB,$Label1,$dgInstalled,$dgNotInstalled,$Label2,$Label3,$cbOU))


#Write your logic code here
$cbOU.Sorted = $True
#this pulls from AD OUs
$grabOU = Get-ADOrganizationalUnit -Filter 'Name -like "*"' | select -ExpandProperty Name | ForEach-Object {[void] $cbOU.Items.Add($_)}

$btnGetKB.Add_click({

#filters on the OU selected
$OU = "OU="
#replace this with your organization's AD distinguished name.
$base = ",DC=dsyncd,DC=local"
#combines everything
$sb = $OU+($cbOU.text)+$base
#creates computers array
$computers = Get-ADComputer -Filter * -SearchBase $sb | Select-Object -expandproperty name 
#loop through OU to test for KB

foreach ($computer in $computers) {
    [string]$kb = $txtKB.Text
    
    if (test-Connection -Cn $computer -quiet) {
       if (Invoke-command -Computername $computer -ScriptBlock {powershell.exe get-hotfix $kb} -AsJob){ $dgInstalled.Rows.Add($computer) }
            else { $dgNotInstalled.Rows.Add($computer) }
    }
    else { $dgNotInstalled.Rows.Add($computer + " Offline") }    
  }

})

[void]$KBSearch.ShowDialog()
